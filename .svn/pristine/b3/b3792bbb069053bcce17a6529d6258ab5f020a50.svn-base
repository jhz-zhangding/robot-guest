package com.efrobot.guest;

import android.app.Application;
import android.content.Context;
import android.content.Intent;
import android.util.Log;
import android.widget.Toast;

import com.efrobot.guest.bean.CustomActionBean;
import com.efrobot.guest.dao.ActionBaseDao;
import com.efrobot.guest.dao.ExchangeModeDao;
import com.efrobot.guest.dao.RemarkDao;
import com.efrobot.guest.dao.SettingDao;
import com.efrobot.guest.dao.UltrasonicDao;
import com.efrobot.guest.db.DbHelper;
import com.efrobot.guest.main.MainActivity;
import com.efrobot.guest.utils.GuestDes3Util;
import com.efrobot.guest.utils.PreferencesUtils;
import com.efrobot.library.mvp.utils.L;
import com.efrobot.speechsdk.SpeechManager;

import java.lang.reflect.Method;
import java.util.ArrayList;

/**
 * Created by Administrator on 2017/3/2.
 */
public class GuestsApplication extends Application {
    private DbHelper mDbHelper;

    private String TAG = getClass().getSimpleName();
    private String PACKGE_NAME = "com.efrobot.guests:";
    private String mRogotSnNumber;


    @Override
    public void onCreate() {
        super.onCreate();
        L.i(TAG, "into application");
        SpeechManager.getInstance().registerSpeechSDK(this, mISpeech);


        ArrayList<CustomActionBean> listBean = new ArrayList<CustomActionBean>();
        CustomActionBean bean = new CustomActionBean();
        bean.setFace("");
        bean.setHead("");
        bean.setWing("");
        // 进入常亮
        int lightType = 1;
        bean.setLight(lightType);
        listBean.add(bean);
        getActionDao().insertAction(listBean);

        ArrayList<CustomActionBean> listBean1 = new ArrayList<CustomActionBean>();
        CustomActionBean bean1 = new CustomActionBean();
        bean1.setFace("");
        bean1.setHead("");
        bean1.setWing("");
        // 退出关闭
        int lightTypeEnd = 0;
        bean1.setLight(lightTypeEnd);
        listBean1.add(bean1);
        getActionDao().insertEndAction(listBean1);

//        //设置超声波
//        UlPlaceBean ulPlaceBeen = new UlPlaceBean();
//        ulPlaceBeen.setUltrasonicId(0);
//        ulPlaceBeen.setIsOpenValue(1);
//        ulPlaceBeen.setDistanceValue("100");
//        getUltrasonicDao().insert(ulPlaceBeen);
//
//        UlPlaceBean ulPlaceBeen1 = new UlPlaceBean();
//        ulPlaceBeen1.setUltrasonicId(4);
//        ulPlaceBeen1.setIsOpenValue(1);
//        ulPlaceBeen1.setDistanceValue("100");
//        getUltrasonicDao().insert(ulPlaceBeen);

        String[] propertys = {"ro.boot.serialno", "ro.serialno"};
        for (String key : propertys) {
//          String v = android.os.SystemProperties.get(key);
            mRogotSnNumber = getAndroidOsSystemProperties(key);
            Log.e("", "get " + key + " : " + mRogotSnNumber);
        }
        if(!mRogotSnNumber.isEmpty()) {
            String encryptNumber = null;
            try {
                encryptNumber = GuestDes3Util.encode(mRogotSnNumber);
                L.e("3Des加密", "SN号码：" + mRogotSnNumber + "     3Des_password = " + encryptNumber + "end");
                if (!encryptNumber.isEmpty()) {
                    PreferencesUtils.putString(this, MainActivity.SP_GUEST_PASSWORD, encryptNumber.trim());
                } else {
                    Toast.makeText(getContext(), "加密失败", Toast.LENGTH_SHORT).show();
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    public void startMainActiviyt(int type) {
        Intent intent = getPackageManager().getLaunchIntentForPackage("com.efrobot.guests");
        intent.putExtra("type", type);
        startActivity(intent);
    }


    public GuestsApplication getContext() {
        return this;
    }


    String data = "[\n" +
            "    {\n" +
            "        \"code\": \"1000\",\n" +
            "        \"ins\": \"开始迎宾\",\n" +
            "        \"packageName\": \"com.efrobot.guests\",\n" +
            "        \"reply\": \"好的\",\n" +
            "        \"type\": \"0\"\n" +
            "    },\n" +
            "    {\n" +
            "        \"code\": \"1001\",\n" +
            "        \"ins\": \"关闭迎宾\",\n" +
            "        \"packageName\": \"com.efrobot.guests\",\n" +
            "        \"reply\": \"好的\",\n" +
            "        \"type\": \"0\"\n" +
            "    }\n" +
            "]";


    public void setData() {
        try {
            SpeechManager.getInstance().setData(data);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    SpeechManager.ISpeech mISpeech = new SpeechManager.ISpeech() {

        @Override
        public void onRegisterSuccess() {

            setData();
            Log.i(TAG, PACKGE_NAME + " onRegisterSuccess");
        }

        @Override
        public void onRegisterFail() {
            Log.i(TAG, PACKGE_NAME + " onRegisterFail");

        }
    };

    /**
     * 初始化
     *
     * @param context Application
     * @return Application
     */
    public static GuestsApplication from(Context context) {
        if (context != null)
            return (GuestsApplication) context.getApplicationContext();
        else return null;
    }

    /**
     * 获取数据库操作类
     *
     * @return 数据库操作类
     */

    public synchronized DbHelper getDataBase() {
        if (mDbHelper == null)
            mDbHelper = new DbHelper(getApplicationContext());
        return mDbHelper;
    }

    RemarkDao mDataDao;

    public RemarkDao getRemarkDao() {
        if (mDataDao == null) {
            mDataDao = new RemarkDao(getDataBase());
        }
        return mDataDao;
    }


    SettingDao mSettingDao;

    public SettingDao getSettingDao() {
        if (mSettingDao == null) {
            mSettingDao = new SettingDao(getDataBase());
        }
        return mSettingDao;
    }


    UltrasonicDao ultrasonicDao;

    public UltrasonicDao getUltrasonicDao() {
        if (ultrasonicDao == null) {
            ultrasonicDao = new UltrasonicDao(getDataBase());
        }
        return ultrasonicDao;
    }

    ActionBaseDao actionBaseDao;

    public ActionBaseDao getActionDao() {
        if (actionBaseDao == null)
            actionBaseDao = new ActionBaseDao(getDataBase());
        return actionBaseDao;
    }

    ExchangeModeDao exchangeModeDao;

    public ExchangeModeDao getModeDao() {
        if (exchangeModeDao == null)
            exchangeModeDao = new ExchangeModeDao(getDataBase());
        return exchangeModeDao;
    }

    static Method systemProperties_get = null;

    static String getAndroidOsSystemProperties(String key) {
        String ret;
        try {
            systemProperties_get = Class.forName("android.os.SystemProperties").getMethod("get", String.class);
            if ((ret = (String) systemProperties_get.invoke(null, key)) != null)
                return ret;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }

        return "";
    }

}
