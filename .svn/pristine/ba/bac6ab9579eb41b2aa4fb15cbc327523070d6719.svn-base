package com.efrobot.guest.setting;

import android.app.AlertDialog;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.database.Cursor;
import android.net.Uri;
import android.os.Handler;
import android.os.Message;
import android.text.TextUtils;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.BaseAdapter;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.CompoundButton;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.RadioButton;
import android.widget.RadioGroup;
import android.widget.TextView;
import android.widget.Toast;

import com.efrobot.guest.R;
import com.efrobot.guest.action.ActionActivity;
import com.efrobot.guest.action.CustomAddActivity;
import com.efrobot.guest.base.GuestsBaseActivity;
import com.efrobot.guest.bean.Location;
import com.efrobot.guest.bean.WeekBean;
import com.efrobot.guest.service.UltrasonicService;
import com.efrobot.guest.speech.AlarmUlService;
import com.efrobot.guest.utils.CustomHintDialog;
import com.efrobot.guest.utils.DatePickerUtils;
import com.efrobot.guest.utils.PreferencesUtils;
import com.efrobot.library.RobotManager;
import com.efrobot.library.RobotState;
import com.efrobot.library.mvp.presenter.BasePresenter;
import com.efrobot.library.mvp.utils.L;
import com.efrobot.speechsdk.SpeechManager;

import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;

/**
 * Created by Administrator on 2017/3/2.
 */
public class SettingActivity extends GuestsBaseActivity<SettingPresenter> implements ISettingView, View.OnClickListener, CompoundButton.OnCheckedChangeListener {

    public static int MyUlNum = 6;
    private TextView ulDistanceText1, ulDistanceText2, ulDistanceText3,
            ulDistanceText4, ulDistanceText5, ulDistanceText6;

    //是否自动开始标定
    private CheckBox settingIsOpen;

    //定时任务设置
    private EditText timerStartEdit, timerEndEdit, timerPlace;
    private Button chooseStartDayBtn, chooseEndDayBtn, saveStartBtn;
    private TextView chooseStartTxt, chooseEndTxt;

    //用户设置距离
    private CheckBox checkBox1, checkBox2, checkBox3, checkBox4, checkBox5, checkBox6;
    private EditText ulDistanceEdit1, ulDistanceEdit2, ulDistanceEdit3,
            ulDistanceEdit4, ulDistanceEdit5, ulDistanceEdit6;
    //迎宾语 结束语
    private EditText mTtsValue, mTtsEndValue;
//    private EditText mNumValue, mFarValue;

    //动作设置
    private TextView mWelFace, mWelAction, mWelLight;
    private TextView mEndWelFace, mEndWelAction, mEndWelLight;

    //保存设置
    private TextView mCancle, mAffirm, mTestUlBtn;
    private ImageView mStartBtn;
    private Boolean isAlreadyStart = false;

    //交流模式
    private RadioGroup modeSettingRg;
    private RadioButton voiceMode, customMode;
    public static int selectedVoiceMode = 0;
    public static int selectedCustomMode = 1;
    private int selectedMode = 0;
    private TextView voiceTime;

    //超声波测试数据
    private Button mActionBtn, mEndActionBtn, customSettingBtn;
    private CheckBox[] myCheck = new CheckBox[]{checkBox1, checkBox2, checkBox3, checkBox4, checkBox5, checkBox6};
    private EditText[] myEdit = new EditText[]{ulDistanceEdit1, ulDistanceEdit2, ulDistanceEdit3, ulDistanceEdit4,
            ulDistanceEdit5, ulDistanceEdit6};

    //等待迎宾设置
    private EditText mCanVassTts, mCanvassWaitTime;
    private CheckBox mIsWaveHead;

    private Intent mBootIntent;

    private Handler mHanlder = new Handler() {
        @Override
        public void handleMessage(Message msg) {
            super.handleMessage(msg);
            switch (msg.what) {
                case 0:
                    int maskSwitch = RobotState.getInstance(getContext()).getMaskState();
                    L.i(TAG, "面罩maskSwitch:" + maskSwitch);
                    if (maskSwitch == 0) {
                        mServiceIntent = new Intent(getContext(), UltrasonicService.class);
                        getContext().getApplicationContext().startService(mServiceIntent);
                        showToast("开始迎宾");

                    }
                    break;
            }
        }
    };

    @Override
    public BasePresenter createPresenter() {
        return new SettingPresenter(this);
    }

    @Override
    protected int getContentViewResource() {
        return R.layout.activity_setting;
    }

    @Override
    public Context getContext() {
        return this;
    }

    @Override
    protected void onViewInit() {
        super.onViewInit();

        mHanlder.sendEmptyMessageDelayed(0, 5000);
        //开始获取轮子状态并保存
        PreferencesUtils.putBoolean(getContext().getApplicationContext(), "wheel_mode", RobotManager.getInstance(getContext()).getSettingWheelsState());

        //测试数据
        ulDistanceText1 = (TextView) findViewById(R.id.ul_place_test_edit1);
        ulDistanceText2 = (TextView) findViewById(R.id.ul_place_test_edit2);
        ulDistanceText3 = (TextView) findViewById(R.id.ul_place_test_edit3);
        ulDistanceText4 = (TextView) findViewById(R.id.ul_place_test_edit4);
        ulDistanceText5 = (TextView) findViewById(R.id.ul_place_test_edit5);
        ulDistanceText6 = (TextView) findViewById(R.id.ul_place_test_edit6);

        settingIsOpen = (CheckBox) findViewById(R.id.setting_is_open);

        //设置数据
        myCheck[0] = (CheckBox) findViewById(R.id.ul_place_ck1);
        myCheck[1] = (CheckBox) findViewById(R.id.ul_place_ck2);
        myCheck[2] = (CheckBox) findViewById(R.id.ul_place_ck3);
        myCheck[3] = (CheckBox) findViewById(R.id.ul_place_ck4);
        myCheck[4] = (CheckBox) findViewById(R.id.ul_place_ck5);
        myCheck[5] = (CheckBox) findViewById(R.id.ul_place_ck6);
        myEdit[0] = (EditText) findViewById(R.id.ul_place_edit1);
        myEdit[1] = (EditText) findViewById(R.id.ul_place_edit2);
        myEdit[2] = (EditText) findViewById(R.id.ul_place_edit3);
        myEdit[3] = (EditText) findViewById(R.id.ul_place_edit4);
        myEdit[4] = (EditText) findViewById(R.id.ul_place_edit5);
        myEdit[5] = (EditText) findViewById(R.id.ul_place_edit6);

        //定时任务
        timerStartEdit = (EditText) findViewById(R.id.timer_start_edit);
        timerEndEdit = (EditText) findViewById(R.id.timer_end_edit);
        timerPlace = (EditText) findViewById(R.id.timer_choose_place);
        chooseStartTxt = (TextView) findViewById(R.id.timer_start_select_day);
        chooseEndTxt = (TextView) findViewById(R.id.timer_end_select_day);


        chooseStartDayBtn = (Button) findViewById(R.id.timer_start_choose_days);
        chooseEndDayBtn = (Button) findViewById(R.id.timer_end_choose_days);
        saveStartBtn = (Button) findViewById(R.id.timer_save_start);
        //获取保存设置
        isAlreadyStart = PreferencesUtils.getBoolean(getContext().getApplicationContext(), "isAlreadyStart", false);
        // 是否已经开启了定时功能
        if (isAlreadyStart) {
            saveStartBtn.setText("取消定时");
        } else {
            saveStartBtn.setText("开启定时");
        }


        mTtsValue = (EditText) findViewById(R.id.tts_value_edit);
        mTtsEndValue = (EditText) findViewById(R.id.tts_end_value_edit);
//        mNumValue = (EditText) findViewById(R.id.num_value_edit);
//        mFarValue = (EditText) findViewById(R.id.num_far_value_edit);
        mActionBtn = (Button) findViewById(R.id.action_setting_btn);
        mEndActionBtn = (Button) findViewById(R.id.end_action_setting_btn);

        mWelFace = (TextView) findViewById(R.id.wel_face);
        mWelAction = (TextView) findViewById(R.id.wel_action);
        mWelLight = (TextView) findViewById(R.id.wel_light);

        modeSettingRg = (RadioGroup) findViewById(R.id.mode_setting);
        voiceMode = (RadioButton) findViewById(R.id.voice_communication_mode);
        customMode = (RadioButton) findViewById(R.id.user_custom_mode);
        customSettingBtn = (Button) findViewById(R.id.custom_setting_btn);

        mEndWelFace = (TextView) findViewById(R.id.end_wel_face);
        mEndWelAction = (TextView) findViewById(R.id.end_wel_action);
        mEndWelLight = (TextView) findViewById(R.id.end_wel_light);

        mCancle = (TextView) findViewById(R.id.cancel);
        mAffirm = (TextView) findViewById(R.id.affirm);
        mStartBtn = (ImageView) findViewById(R.id.ultrasonic_open_btn);
        mTestUlBtn = (TextView) findViewById(R.id.ultrasonic_test_btn);
        mTestUlBtn.setVisibility(View.GONE);

        voiceTime = (TextView) findViewById(R.id.voice_time);

        int savedMode = PreferencesUtils.getInt(this.getApplicationContext(), "mMode", 0);
        selectedMode = savedMode;
        if (savedMode == SettingActivity.selectedVoiceMode) {
            voiceMode.setChecked(true);
        } else if (savedMode == SettingActivity.selectedCustomMode) {
            customMode.setChecked(true);
        }
        modeSettingRg.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(RadioGroup radioGroup, int i) {
                if (i == R.id.voice_communication_mode) {
                    selectedMode = selectedVoiceMode;
                } else if (i == R.id.user_custom_mode) {
                    selectedMode = selectedCustomMode;
                }
            }
        });

        //等待迎宾设置
         mCanVassTts = (EditText) findViewById(R.id.canvass_tts_value_edit);
         mCanvassWaitTime = (EditText) findViewById(R.id.canvass_time);
         mIsWaveHead = (CheckBox) findViewById(R.id.wave_head_ck);

//        RobotManager.getInstance(this).disableWheel();
    }

    @Override
    protected void setOnListener() {
        super.setOnListener();
        for (int i = 0; i < myEdit.length; i++) {
            if (TextUtils.isEmpty(myEdit[i].getText())) {
                myEdit[i].setFocusableInTouchMode(false);
            } else {
                myEdit[i].setFocusableInTouchMode(true);
            }
            myCheck[i].setOnCheckedChangeListener(this);
        }
        mCancle.setOnClickListener(this);
        mAffirm.setOnClickListener(this);
        mStartBtn.setOnClickListener(this);
//        mTestUlBtn.setOnClickListener(this);

        customSettingBtn.setOnClickListener(this);

        mActionBtn.setOnClickListener(this);
        mEndActionBtn.setOnClickListener(this);
        findViewById(R.id.ultrasonic_init_btn).setOnClickListener(this);

        //定时任务
        chooseStartDayBtn.setOnClickListener(this);
        chooseEndDayBtn.setOnClickListener(this);
        timerStartEdit.setFocusable(false);
        timerEndEdit.setFocusable(false);
        timerPlace.setFocusable(false);
        DatePickerUtils.getInstance().setDataPickDialog(timerStartEdit, this);
        DatePickerUtils.getInstance().setDataPickDialog(timerEndEdit, this);
        timerPlace.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if (isAlreadyStart) {
                    showToast("已经开启了定时任务");
                } else
                    initTimerPlaceData();
            }
        });
        saveStartBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                isAlreadyStart = !isAlreadyStart;
                setTimerBtn();
            }
        });
    }

    private void setTimerBtn() {
        // 是否已经开启了定时功能
        if (isAlreadyStart) {
            saveStartBtn.setText("取消定时");
            saveTimerData();

            //启动定时任务
            mBootIntent = new Intent(this, AlarmUlService.class);
            startService(mBootIntent);
        } else {
            saveStartBtn.setText("开启定时");
            AlarmUlService.stopAlarm();
            if (mBootIntent != null) {
                stopService(mBootIntent);
            }
        }
        PreferencesUtils.putBoolean(getContext().getApplicationContext(), "isAlreadyStart", isAlreadyStart);
    }

    private void saveTimerData() {
        String startTime = timerStartEdit.getText().toString();
        String endTime = timerEndEdit.getText().toString();
        String guestPlace = timerPlace.getText().toString();
        if (!TextUtils.isEmpty(startTime)) {
            ((SettingPresenter) mPresenter).affrim();
        } else
            showToast("启动时间为空");
    }

    @Override
    public void onClick(View view) {
        switch (view.getId()) {
            case R.id.cancel:
                ((SettingPresenter) mPresenter).cancle();
                break;
            case R.id.affirm:
                ((SettingPresenter) mPresenter).affrim();
                break;
            case R.id.ultrasonic_open_btn: //开始迎宾
                ((SettingPresenter) mPresenter).affrim();
                showDialog("即将开始迎宾，请关闭面罩后开始迎宾");
                break;
            case R.id.ultrasonic_test_btn: //测试超声波
//                startActivity(UsherActivity.class);
                break;
            case R.id.action_setting_btn:
                Intent intent = new Intent(this, ActionActivity.class);
                intent.putExtra("type", 1); //开始设置
                startActivityForResult(intent, 1);
                break;
            case R.id.custom_setting_btn: //打开自定义设置
                startActivity(new Intent(this, CustomAddActivity.class));
                break;
            case R.id.end_action_setting_btn:
                Intent intentEnd = new Intent(this, ActionActivity.class);
                intentEnd.putExtra("type", 2); //结束设置
                startActivityForResult(intentEnd, 1);
                break;
            case R.id.ultrasonic_init_btn:
                //初始化超声波
                ((SettingPresenter) mPresenter).showDialog(getString(R.string.init_ultrasonic_hint));
                break;
            case R.id.timer_start_choose_days:
                String selectedDays = PreferencesUtils.getString(this, "selectedStartDays");
                setDialog(selectedDays, 0);
                break;
            case R.id.timer_end_choose_days:
                String selectedEndDays = PreferencesUtils.getString(this, "selectedEndDays");
                setDialog(selectedEndDays, 1);
                break;
        }
    }

    private void setDialog(String selectedDays, final int type) {
        if(TextUtils.isEmpty(selectedDays)) {
            selectedDays = "周一:周二:周三:周四:周五";
        }
        List<WeekBean> startWeekLists = initWeekData(selectedDays);
        DatePickerUtils.getInstance().setDayPickDialog(startWeekLists, this, new DatePickerUtils.OnDayCheckListener() {
            @Override
            public void onCheckListData(LinkedHashMap<String, Boolean> maps) {
                StringBuilder stringBuilder = new StringBuilder();
                for (LinkedHashMap.Entry<String, Boolean> map : maps.entrySet()) {
                    boolean ischeck = map.getValue();
                    if(ischeck){
                        stringBuilder.append(map.getKey() + ":");
                    }
                }
                if(stringBuilder.toString().contains(":")) {
                    stringBuilder.deleteCharAt(stringBuilder.lastIndexOf(":"));
                }

                if(type == 0) {
                    PreferencesUtils.putString(SettingActivity.this, "selectedStartDays", stringBuilder.toString());
                    chooseStartTxt.setText(stringBuilder.toString());
                    if(TextUtils.isEmpty(chooseStartTxt.getText())) {
                        chooseStartTxt.setText("周一:周二:周三:周四:周五");
                    }
                } else if(type == 1) {
                    PreferencesUtils.putString(SettingActivity.this, "selectedEndDays", stringBuilder.toString());
                    chooseEndTxt.setText(stringBuilder.toString());
                    if(TextUtils.isEmpty(chooseEndTxt.getText())) {
                        chooseEndTxt.setText("周一:周二:周三:周四:周五");
                    }
                }

            }
        });
    }

    private List<WeekBean> initWeekData(String selectedDays) {
        List<WeekBean> startWeekLists = new ArrayList<WeekBean>();

        String[] days = selectedDays.split(":");
        for (int i = 0; i < days.length; i++) {
            WeekBean weekBean = new WeekBean();
            weekBean.setDay(days[i]);
            weekBean.setCheck(true);
            startWeekLists.add(weekBean);
        }


        return startWeekLists;
    }


    @Override
    public String getDistanceValue() {
        return "";
    }

    @Override
    public String getTtsValue() {
        return mTtsValue.getText().toString();
    }

    @Override
    public String getTtsEndValue() {
        return mTtsEndValue.getText().toString();
    }

//    @Override
//    public String getNumValue() {
//        return mNumValue.getText().toString();
//    }
//
//    @Override
//    public String getFarNumValue() {
//        return mFarValue.getText().toString();
//    }

    @Override
    public int getIsOpenValue(int number) {
        return (myCheck[number].isChecked() ? 1 : 0);
    }

    @Override
    public String getOpenDistanceValue(int number) {
        if (myEdit[number].getText().toString().isEmpty()) {
            return "";
        }
        return myEdit[number].getText().toString();
    }

    @Override
    public void setDistance(String distance) {
    }

    @Override
    public void setTts(String tts) {
        mTtsValue.setText(tts);
    }

    @Override
    public void setTtsEnd(String ttsEnd) {
        mTtsEndValue.setText(ttsEnd);
    }

//    @Override
//    public void setNum(String num) {
//        mNumValue.setText(num);
//    }
//
//    @Override
//    public void setFarNumValue(String num) {
//        mFarValue.setText(num);
//    }

    @Override
    public void setIsOpenValue(int number, int isOpenValue) {
        myCheck[number].setChecked(isOpenValue == 1 ? true : false);
    }

    @Override
    public void setOpenDistanceValue(int number, String openDistanceValue) {
        myEdit[number].setEnabled(true);
        myEdit[number].setText(openDistanceValue);
    }

    @Override
    public void setWelFace(String faceText) {
        mWelFace.setText(faceText);
    }

    @Override
    public void setWelAction(String actionText) {
        mWelAction.setText(actionText);
    }

    @Override
    public void setWelLight(String lightText) {
        mWelLight.setText(lightText);
    }

    @Override
    public void setEndWelFace(String faceText) {
        mEndWelFace.setText(faceText);
    }

    @Override
    public void setEndWelAction(String actionText) {
        mEndWelAction.setText(actionText);
    }

    @Override
    public void setEndWelLight(String lightText) {
        mEndWelLight.setText(lightText);
    }

    @Override
    public void setExchangeMode(int mode) {
        this.selectedMode = mode;
        if (mode == selectedVoiceMode) {
            voiceMode.setChecked(true);
        } else if (mode == selectedCustomMode) {
            customMode.setChecked(true);
        }
    }

    @Override
    public int getExchangeMode() {
        return selectedMode;
    }

    @Override
    public void setVoiceTime(String time) {
        voiceTime.setText(time);
    }

    @Override
    public String getVoiceTime() {
        return voiceTime.getText().toString();
    }

    @Override
    public void setTestUltrasonic(int number, int valueNG) {
    }

    @Override
    public void setDistance0(String distance) {
        ulDistanceText1.setText(distance);
    }

    @Override
    public void setDistance1(String distance) {
        ulDistanceText2.setText(distance);
    }

    @Override
    public void setDistance7(String distance) {
        ulDistanceText3.setText(distance);
    }

    @Override
    public void setDistance8(String distance) {
        ulDistanceText4.setText(distance);
    }

    @Override
    public void setDistance9(String distance) {
        ulDistanceText5.setText(distance);
    }

    @Override
    public void setDistance10(String distance) {
        ulDistanceText6.setText(distance);
    }

    @Override
    public CheckBox getIsAutoOpen() {
        return settingIsOpen;
    }

    @Override
    public void setAutoOpen(boolean isAuto) {
        settingIsOpen.setChecked(isAuto);
    }

    @Override
    public void setStartTime(String startTime) {
        timerStartEdit.setText(startTime);
    }

    @Override
    public void setEndTime(String endTime) {
        timerEndEdit.setText(endTime);
    }

    @Override
    public void setTimerPlace(String guestPlace) {
        timerPlace.setText(guestPlace);
    }

    @Override
    public String getStartTime() {
        return timerStartEdit.getText().toString();
    }

    @Override
    public String getEndTime() {
        return timerEndEdit.getText().toString();
    }

    @Override
    public String getTimerPlace() {
        return timerPlace.getText().toString();
    }

    @Override
    public String getCanVassTts() {
        return mCanVassTts.getText().toString();
    }

    @Override
    public String getCanvassWaitTime() {
        return mCanvassWaitTime.getText().toString();
    }

    @Override
    public boolean isWaveHead() {
        return mIsWaveHead.isChecked();
    }

    @Override
    public void setCanVassTts(String canvassTts) {
        mCanVassTts.setText(canvassTts);
    }

    @Override
    public void setCanVassTime(String canvassWaitTime) {
        mCanvassWaitTime.setText(canvassWaitTime);
    }

    @Override
    public void setWaveHead(boolean isWaveHead) {
        mIsWaveHead.setChecked(isWaveHead);
    }


    @Override
    public void onCheckedChanged(CompoundButton compoundButton, boolean b) {
        switch (compoundButton.getId()) {
            case R.id.ul_place_ck1:
                setCheckChange(compoundButton, 0);
                break;
            case R.id.ul_place_ck2:
                setCheckChange(compoundButton, 1);
                break;
            case R.id.ul_place_ck3:
                setCheckChange(compoundButton, 2);
                break;
            case R.id.ul_place_ck4:
                setCheckChange(compoundButton, 3);
                break;
            case R.id.ul_place_ck5:
                setCheckChange(compoundButton, 4);
                break;
            case R.id.ul_place_ck6:
                setCheckChange(compoundButton, 5);
                break;
        }
    }

    private void setCheckChange(CompoundButton compoundButton, int position) {
        if (compoundButton.isChecked()) {
            myEdit[position].setFocusableInTouchMode(true);
            myEdit[position].setFocusable(true);
            myEdit[position].requestFocus();
        } else {
            myEdit[position].setFocusableInTouchMode(false);
            myEdit[position].setFocusable(false);
        }
    }

    @Override
    protected void onPause() {
        super.onPause();
        L.i(TAG, "SettingActivity onPause");
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (requestCode == 1 && resultCode == 1) { //从设置回来刷新
            ((SettingPresenter) mPresenter).updateData();
        }
    }

    @Override
    protected void onDestroy() {
        L.i(TAG, "SettingActivity onDestroy");
        RobotManager.getInstance(getApplicationContext()).getControlInstance().setLightBeltBrightness(0);
        if (mServiceIntent != null) {
            getContext().getApplicationContext().stopService(mServiceIntent);
        }
//        if (lidBoardReceive != null) {
//            unregisterReceiver(lidBoardReceive);
//        }
        super.onDestroy();

    }

    /**
     * 任务地点
     */

    private AlertDialog placeDialog;

    private void initTimerPlaceData() {
        ArrayList<Location> locationList = query(getContext());
        if (locationList == null || locationList.size() == 0) {
            Toast.makeText(getContext(), "无迎宾地点", Toast.LENGTH_SHORT).show();
            return;
        }
        placeDialog = new AlertDialog.Builder(getContext()).create();
        placeDialog.setCancelable(true);
        placeDialog.show();
        View dialogView = LayoutInflater.from(getContext()).inflate(R.layout.timer_place_dialog, null);
//        placeDialog.getWindow().setContentView(R.layout.timer_place_dialog);
        placeDialog.getWindow().setContentView(dialogView);
        ListView listView = (ListView) dialogView.findViewById(R.id.timer_place_list_view);

        PlaceAdapter adapter = new PlaceAdapter(getContext(), locationList);
        listView.setAdapter(adapter);


    }

    private class PlaceAdapter extends BaseAdapter {

        ArrayList<Location> locationList;
        Context context;

        private PlaceAdapter(Context context, ArrayList<Location> locationList) {
            this.locationList = locationList;
            this.context = context;
        }

        @Override
        public int getCount() {
            return locationList.size();
        }

        @Override
        public Object getItem(int i) {
            return i;
        }

        @Override
        public long getItemId(int i) {
            return i;
        }

        @Override
        public View getView(final int i, View convertView, ViewGroup viewGroup) {
            convertView = LayoutInflater.from(context).inflate(R.layout.timer_place_item, viewGroup, false);
            TextView placeText = (TextView) convertView.findViewById(R.id.timer_place_item_text);

            if (locationList != null && locationList.size() > 0) {
                placeText.setText(locationList.get(i).getLocation_name());
                placeText.setOnClickListener(new View.OnClickListener() {
                    @Override
                    public void onClick(View view) {
                        timerPlace.setText(locationList.get(i).getLocation_name());
                        if (placeDialog != null) {
                            placeDialog.dismiss();
                        }
                    }
                });
            }

            return convertView;
        }
    }

    public static ArrayList<Location> query(Context mContext) {
        ArrayList<Location> locationList = new ArrayList<Location>();
        Uri uri = Uri.parse("content://com.efrobot.services.common/location");
        try {
            Cursor cursor = mContext.getContentResolver().query(uri, null, null, null, null);
            while (cursor.moveToNext()) {

                String locationName = null;
                int location_name = cursor.getColumnIndex("location_name");
                if (location_name > 0) {
                    locationName = cursor.getString(location_name);
                }

                String locationX = null;
                int location_x = cursor.getColumnIndex("location_x");
                if (location_name > 0) {
                    locationX = cursor.getString(location_x);
                }

                String locationY = null;
                int location_y = cursor.getColumnIndex("location_y");
                if (location_y > 0) {
                    locationY = cursor.getString(location_y);
                }

                String locationType = null;
                int location_type = cursor.getColumnIndex("location_type");
                if (location_type > 0) {
                    locationType = cursor.getString(location_type);
                }

                String locationAngle = null;
                int location_angle = cursor.getColumnIndex("location_angle");
                if (location_angle > 0) {
                    locationAngle = cursor.getString(location_angle);
                }

                Location location = new Location(locationName, locationType, locationX, locationY, locationAngle);
                locationList.add(location);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return locationList;
    }

    /**
     * 提示框
     */
    private Intent mServiceIntent;
    private CustomHintDialog dialog;

    public void showDialog(String content) {
        alreadyClosed = false;
        dialog = new CustomHintDialog(getContext(), -1);
        dialog.setMessage(content);
        dialog.setCancelable(true);
        dialog.show();
        IntentFilter dynamic_filter = new IntentFilter();
        dynamic_filter.addAction(ROBOT_MASK_CHANGE);            //添加动态广播的Action
        getContext().registerReceiver(lidBoardReceive, dynamic_filter);
        dialog.setOnDismissListener(new CustomHintDialog.OnDismissListener() {
            @Override
            public void onDismiss() {
//                if(dialog != null && !dialog.isShowing()) {
//                    getContext().unregisterReceiver(lidBoardReceive);
//                }
            }
        });
    }

    public final static String ROBOT_MASK_CHANGE = "android.intent.action.MASK_CHANGED";
    public final static String KEYCODE_MASK_ONPROGRESS = "KEYCODE_MASK_ONPROGRESS"; //开闭状态
    public final static String KEYCODE_MASK_CLOSE = "KEYCODE_MASK_CLOSE"; //关闭面罩
    public final static String KEYCODE_MASK_OPEN = "KEYCODE_MASK_OPEN";  //打开面罩
    private boolean alreadyClosed = false;
    private BroadcastReceiver lidBoardReceive = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            if (ROBOT_MASK_CHANGE.equals(intent.getAction())) {
                boolean close = intent.getBooleanExtra(KEYCODE_MASK_CLOSE, false);
                boolean maskOnProgress = intent.getBooleanExtra(KEYCODE_MASK_ONPROGRESS, false);
                boolean maskOpen = intent.getBooleanExtra(KEYCODE_MASK_OPEN, false);
                L.i(TAG, "lidBoardReceive get data----" + "close----" + close + "  maskOnProgress----" + maskOnProgress + "  maskOpen----" + maskOpen);
                if (close) {
                    alreadyClosed = true;
                    try {
                        if (null != dialog) {
                            dialog.dismiss();
                        }
                        SpeechManager.getInstance().removeSpeechState(getContext().getApplicationContext(), 11);
                        L.i(TAG, "lidBoardReceive close----" + close + "   start service");
                        //开启迎宾
                        mServiceIntent = new Intent(getContext(), UltrasonicService.class);
                        getContext().getApplicationContext().startService(mServiceIntent);
//                        ((SettingPresenter)mPresenter).unRegisterAllCallBack();
                        //启动迎宾禁止轮子运动
//                        WheelActionUtils.getInstance(getContext()).closeWheelAction();
                        UltrasonicService.IsOpenRepeatLight = false;
                        unregisterReceiver(lidBoardReceive);
                        L.i(TAG, "lidBoardReceive unregisterReceiver(this)");
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
//                if (maskOnProgress || maskOpen) {
//                    if (null != mServiceIntent) {
//                        L.i(TAG, "stop service");
//                        getContext().getApplicationContext().stopService(mServiceIntent);
//                        RobotManager.getInstance(getContext().getApplicationContext()).getControlInstance().setLightBeltBrightness(0);
//                        UltrasonicService.IsOpenRepeatLight = false;
//                    }
//                    L.i(TAG, "lidBoardReceive maskOnProgress maskOpen" + "----alreadyClosed=" + alreadyClosed);
//                    if (alreadyClosed) {
//                        unregisterReceiver(this);
//                        L.i(TAG, "lidBoardReceive unregisterReceiver(this)");
//                        AlarmUlService.stopAlarm();
//                    }
//                }
            }
        }
    };


}
